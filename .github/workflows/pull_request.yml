name: Pull Request

on:
  pull_request:
    types:
      [
        opened,
        reopened,
        synchronize,
        review_requested,
        ready_for_review,
        edited,
      ]

jobs:
  check-pr-title:
    runs-on: ubuntu-latest
    env:
      PR_TITLE: ${{ github.event.pull_request.title }}
      ALLOWED_PREFIXES: "feat: chore: fix: !feat:"
    steps:
      - name: Fail if PR title does not start with an allowed prefix
        run: |
          echo "PR title: $PR_TITLE"
          for prefix in $ALLOWED_PREFIXES; do
            if [[ "$PR_TITLE" == "$prefix"* ]]; then
              echo "✅ PR title is valid."
              exit 0
            fi
          done
          echo "::error::❌ PR title must start with one of: $ALLOWED_PREFIXES"
          exit 1

  check:
    needs: check-pr-title
    permissions:
      pull-requests: read
      contents: read
    uses: ./.github/workflows/get_changes.yml
    with:
      ref: ${{ github.sha }}
    secrets: inherit

  format-github:
    needs: check
    runs-on: ubuntu-latest
    if: ${{ needs.check.outputs.github == 'true' }}
    name: Run github formatting checks
    timeout-minutes: 2
    steps:
      - uses: actions/checkout@v4
      - uses: raven-actions/actionlint@v2
        with:
          shellcheck: false
          pyflakes: false

  format-terragrunt:
    needs: check
    runs-on: ubuntu-latest
    if: ${{ needs.check.outputs.terragrunt == 'true' }}
    name: Run terragrunt formatting checks
    timeout-minutes: 2
    steps:
      - uses: actions/checkout@v4
      - uses: hashicorp/setup-terraform@v3
      - uses: autero1/action-terragrunt@v1.3.2
        with:
          terragrunt_version: 0.45.10

      - name: Terraform fmt check
        run: terraform fmt -check -recursive
        working-directory: infra

      - name: Terragrunt hclfmt check
        run: terragrunt hclfmt --terragrunt-check
        working-directory: infra

  lint-terraform:
    needs: check
    runs-on: ubuntu-latest
    if: ${{ needs.check.outputs.terraform == 'true' }}
    name: Run terraform lint checks
    timeout-minutes: 2
    steps:
      - uses: actions/checkout@v4
      - uses: terraform-linters/setup-tflint@v4

      - name: Init TFLint
        run: tflint --init

      - name: "Run terraform lint checks"
        uses: chrispsheehan/just-aws-oidc-action@0.3.0
        with:
          aws_oidc_role_arn: ${{ env.AWS_OIDC_ROLE_ARN }}
          just_action: tf-lint-check

  setup-lambdas:
    if: ${{ needs.check.outputs.lambdas == 'true' }}
    needs: check
    runs-on: ubuntu-latest
    outputs:
      lambda_dirs: ${{ steps.lambda_dirs.outputs.just_outputs }}
    steps:
      - uses: actions/checkout@v4
      - name: Get Lambda Directories
        id: lambda_dirs
        uses: chrispsheehan/just-aws-oidc-action@0.3.0
        with:
          just_action: lambda-get-directories

  build-lambdas:
    if: ${{ needs.check.outputs.lambdas == 'true' }}
    needs: 
      - check
      - setup-lambdas
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        value: ${{ fromJson(needs.setup-lambdas.outputs.lambda_dirs) }}
    steps:
      - uses: actions/checkout@v4

      - name: "Build ${{ matrix.value }} Lambda"
        uses: chrispsheehan/just-aws-oidc-action@0.3.0
        env:
          LAMBDA_NAME: ${{ matrix.value }}
        with:
          aws_oidc_role_arn: ${{ env.AWS_OIDC_ROLE_ARN }}
          just_action: lambda-build
